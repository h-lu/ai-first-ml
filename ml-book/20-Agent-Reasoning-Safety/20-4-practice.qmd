# 20.4 Practice: 为AI团队引入"人工审批"

在本次实践中，我们将在上一章"AI退款处理团队"的基础上，为其加入一个至关重要的"**人工审批 (Human-in-the-Loop)**"环节。

**我们的目标：**
修改原有的`LangGraph`流程，使得当"财务经理Agent"准备调用`process_refund`工具时，整个系统能暂停下来，等待用户的明确批准后，才能继续执行。

### AI协同实践：一个可中断Agent的修改指令剧本

我们将复用上一章的大部分代码，只在关键的图构建部分进行修改。

::: {.callout-note title="请求AI修改图的构建和运行逻辑" icon="fas fa-user-shield"}

**你：** "你好AI助手，请帮我修改上一章的多Agent系统代码，为它加入'人工审批'功能。具体需求如下："

> "1.  **引入Checkpointer**:
>     a.  我们需要一个'检查点'来保存图的状态，以便在中断后能够恢复。请帮我导入`MemorySaver`并创建一个实例。
>     b.  在`graph.compile()`时，将这个`checkpointer`传入。
> "2.  **修改`tool_node`**:
>     a.  修改`tool_node`的逻辑。在它执行完工具调用后，不要直接返回结果。
>     b.  而是检查刚刚被调用的工具名称。如果工具名称是`process_refund`，就在返回的`ToolMessage`中，额外加入一个特殊的`human_approval=True`标记。这个标记将作为我们中断的信号。
> "3.  **修改条件路由**:
>     a.  修改主管节点的条件路由逻辑。
>     b.  在将任务路由给Agent之前，先检查上一条消息是否带有`human_approval=True`的标记。
>     c.  如果带有此标记，则不再路由给任何Agent，而是直接将流程导向`END`，从而实现**中断**。
> "4.  **修改运行逻辑**:
>     a.  编写一个新的、可循环的运行逻辑。
>     b.  在这个循环中，首先调用`app.invoke()`来执行流程。
>     c.  检查应用的输出。如果输出不为空（意味着流程因为中断而暂停了），就打印出当前的状态，并用`input()`函数来询问用户是否批准（'yes/no'）。
>     d.  如果用户输入'yes'，就构造一条表示"批准"的`ToolMessage`，然后调用`app.invoke()`，将这条新消息和之前的状态快照一起传回去，让流程继续。
>     e.  如果用户输入'no'，或者流程正常结束，就退出循环。
> "5.  **配置线程**:
>     a.  为了让同一个用户在中断和继续时能被识别，我们需要为会话配置一个`configurable`的线程ID。"
:::

---

这是我们将要构建的最精密、最安全的AI系统。

请打开你的AI编程环境，将这份详尽的“改造蓝图”交给你的AI助手。与它一起，为你的AI团队装上这个“安全阀”。

当你看到系统在执行高风险操作前，真的停下来，谦逊地寻求你的批准时，你将深刻地体会到，真正强大的人工智能，不是拥有无限的权力，而是拥有被约束和被引导的智慧。

</rewritten_file>